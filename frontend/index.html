<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinTrack - Dashboard Financiero Personal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="app">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span class="logo-icon">‚óà</span>
                    <span class="logo-text">FinTrack</span>
                </div>
                <span class="version">v2.0</span>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item active" data-page="dashboard">
                    <span class="nav-icon">üìä</span>
                    <span class="nav-label">Dashboard</span>
                </li>
                <li class="nav-item" data-page="analysis">
                    <span class="nav-icon">üìà</span>
                    <span class="nav-label">An√°lisis</span>
                </li>
                <li class="nav-item" data-page="transactions">
                    <span class="nav-icon">üí∏</span>
                    <span class="nav-label">Transacciones</span>
                </li>
                <li class="nav-item" data-page="goals">
                    <span class="nav-icon">üéØ</span>
                    <span class="nav-label">Objetivos</span>
                </li>
                <li class="nav-item" data-page="portfolio-manager">
                    <span class="nav-icon">üíº</span>
                    <span class="nav-label">Gestionar Cartera</span>
                </li>
                <li class="nav-item" data-page="alerts">
                    <span class="nav-icon">üîî</span>
                    <span class="nav-label">Alertas</span>
                </li>
                <li class="nav-item" data-page="calculators">
                    <span class="nav-icon">üßÆ</span>
                    <span class="nav-label">Calculadoras</span>
                </li>
                <li class="nav-item" data-page="ai-advisor">
                    <span class="nav-icon">ü§ñ</span>
                    <span class="nav-label">Asesor IA</span>
                </li>
                <li class="nav-item" data-page="news">
                    <span class="nav-icon">üì∞</span>
                    <span class="nav-label">Noticias</span>
                </li>
                <li class="nav-item" data-page="learn">
                    <span class="nav-icon">üìö</span>
                    <span class="nav-label">Aprender</span>
                </li>
                <li class="nav-item" data-page="docs">
                    <span class="nav-icon">üìñ</span>
                    <span class="nav-label">Documentaci√≥n</span>
                </li>
            </ul>
            
            <div class="sidebar-footer">
                <button class="btn-settings" title="Configuraci√≥n">
                    <span>‚öôÔ∏è</span>
                </button>
                <div class="connection-status">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="statusText">Conectando...</span>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <div class="main-wrapper">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <button class="btn-menu-toggle" id="menuToggle">‚ò∞</button>
                    <h1 class="page-title" id="pageTitle">Dashboard</h1>
                </div>
                <div class="header-right">
                    <div class="last-update">
                        <span class="update-label">√öltima actualizaci√≥n</span>
                        <span class="update-time" id="lastUpdate">--:--</span>
                    </div>
                    <button class="btn-refresh" id="btnRefresh" title="Actualizar datos">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6"/>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                        </svg>
                    </button>
                </div>
            </header>

            <!-- Page Content -->
            <main class="main" id="mainContent">
                <!-- Dashboard Page (default) -->
                <div class="page page-dashboard active" id="page-dashboard">
                    <!-- Portfolio Summary Cards -->
                    <section class="summary-section">
                        <div class="card card-total">
                            <div class="card-header">
                                <span class="card-label">Valor Total de Cartera</span>
                                <span class="card-currency" id="baseCurrency">EUR</span>
                            </div>
                            <div class="card-value" id="totalValue">
                                <span class="value-loading">Cargando...</span>
                            </div>
                            <div class="card-change">
                                <span class="change-daily" id="dailyChange">--</span>
                                <span class="change-separator">|</span>
                                <span class="change-total" id="totalGainLoss">--</span>
                            </div>
                        </div>

                        <div class="card card-kpi">
                            <div class="kpi-item" title="CAGR = Crecimiento Anual Compuesto. Mide el rendimiento medio anual de tu cartera. Un CAGR del 7-10% es excelente para inversiones a largo plazo.">
                                <span class="kpi-label">üìà CAGR</span>
                                <span class="kpi-value" id="cagr">--%</span>
                                <span class="kpi-help">Rendimiento anual medio</span>
                            </div>
                            <div class="kpi-item" title="Drawdown = La mayor ca√≠da desde el m√°ximo hist√≥rico de tu cartera. Por ejemplo, si tu cartera lleg√≥ a 1000‚Ç¨ y baj√≥ a 800‚Ç¨, el drawdown es -20%.">
                                <span class="kpi-label">üìâ Max Drawdown</span>
                                <span class="kpi-value negative" id="maxDrawdown">--%</span>
                                <span class="kpi-help">Mayor ca√≠da desde m√°ximo</span>
                            </div>
                            <div class="kpi-item" title="Volatilidad = Cu√°nto sube y baja tu cartera. Mayor volatilidad = m√°s riesgo. Cryptos suelen tener volatilidad alta (>50%), acciones media (15-25%).">
                                <span class="kpi-label">üìä Volatilidad</span>
                                <span class="kpi-value" id="volatility">--%</span>
                                <span class="kpi-help">Variaci√≥n del valor</span>
                            </div>
                            <div class="kpi-item" title="Sharpe Ratio = Rentabilidad ajustada al riesgo. Mayor que 1 = bueno, mayor que 2 = muy bueno. Compara tu rendimiento con el riesgo que tomas.">
                                <span class="kpi-label">‚öñÔ∏è Sharpe</span>
                                <span class="kpi-value" id="sharpeRatio">--</span>
                                <span class="kpi-help">Rendimiento vs Riesgo</span>
                            </div>
                        </div>
                    </section>

                    <!-- Quick Stats -->
                    <section class="quick-stats">
                        <div class="stat-card">
                            <span class="stat-icon">üìà</span>
                            <div class="stat-info">
                                <span class="stat-value" id="bestPerformer">--</span>
                                <span class="stat-label">Mejor rendimiento</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-icon">üìâ</span>
                            <div class="stat-info">
                                <span class="stat-value" id="worstPerformer">--</span>
                                <span class="stat-label">Peor rendimiento</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-icon">üí∞</span>
                            <div class="stat-info">
                                <span class="stat-value" id="dividendsYTD">0 ‚Ç¨</span>
                                <span class="stat-label">Dividendos YTD</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-icon">üìä</span>
                            <div class="stat-info">
                                <span class="stat-value" id="positionsCount">0</span>
                                <span class="stat-label">Posiciones</span>
                            </div>
                        </div>
                    </section>

                    <!-- Charts Section -->
                    <section class="charts-section">
                        <div class="card card-chart">
                            <div class="card-header">
                                <h3>Evoluci√≥n de la Cartera</h3>
                                <div class="chart-controls">
                                    <button class="chart-btn active" data-period="30">1M</button>
                                    <button class="chart-btn" data-period="90">3M</button>
                                    <button class="chart-btn" data-period="180">6M</button>
                                    <button class="chart-btn" data-period="365">1A</button>
                                    <button class="chart-btn" data-period="all">Todo</button>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="portfolioChart"></canvas>
                            </div>
                        </div>
                    </section>

                    <!-- Distributions Section -->
                    <section class="distributions-section">
                        <div class="card card-distribution">
                            <h3>Por Tipo de Activo</h3>
                            <div class="distribution-chart">
                                <canvas id="typeChart"></canvas>
                            </div>
                            <div class="distribution-legend" id="typeLegend"></div>
                        </div>
                        
                        <div class="card card-distribution">
                            <h3>Por Broker</h3>
                            <div class="distribution-chart">
                                <canvas id="brokerChart"></canvas>
                            </div>
                            <div class="distribution-legend" id="brokerLegend"></div>
                        </div>
                        
                        <div class="card card-distribution">
                            <h3>Por Divisa</h3>
                            <div class="distribution-chart">
                                <canvas id="currencyChart"></canvas>
                            </div>
                            <div class="distribution-legend" id="currencyLegend"></div>
                        </div>
                    </section>

                    <!-- Positions Table -->
                    <section class="positions-section">
                        <div class="card card-positions">
                            <div class="card-header">
                                <h3>Posiciones</h3>
                                <div class="positions-controls">
                                    <input type="text" class="search-input" id="searchPositions" placeholder="Buscar...">
                                    <select id="filterType" class="select-filter">
                                        <option value="all">Todos los tipos</option>
                                        <option value="stock">Acciones</option>
                                        <option value="etf">ETFs</option>
                                        <option value="crypto">Crypto</option>
                                    </select>
                                    <select id="filterBroker" class="select-filter">
                                        <option value="all">Todos los brokers</option>
                                    </select>
                                    <button class="btn-export" id="btnExportCSV" title="Exportar CSV">üì•</button>
                                </div>
                            </div>
                            <div class="table-container">
                                <table class="positions-table">
                                    <thead>
                                        <tr>
                                            <th data-sort="ticker">Activo ‚Üï</th>
                                            <th data-sort="type">Tipo</th>
                                            <th data-sort="broker">Broker</th>
                                            <th class="text-right" data-sort="quantity">Cantidad</th>
                                            <th class="text-right" data-sort="avg_price">Coste/Unidad</th>
                                            <th class="text-right" data-sort="current_price">Precio Actual</th>
                                            <th class="text-right" data-sort="market_value">Valor</th>
                                            <th class="text-right" data-sort="gain_loss">P/L</th>
                                            <th class="text-right" data-sort="gain_loss_pct">P/L %</th>
                                            <th class="text-right" data-sort="day_change_pct">D√≠a %</th>
                                            <th class="text-right" data-sort="weight">Peso</th>
                                        </tr>
                                    </thead>
                                    <tbody id="positionsBody">
                                        <tr>
                                            <td colspan="11" class="loading-row">Cargando posiciones...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- Analysis Page -->
                <div class="page page-analysis" id="page-analysis">
                    <section class="analysis-header">
                        <h2>üìà An√°lisis de Activos</h2>
                        <p>Ve la evoluci√≥n de cada inversi√≥n y decide cu√°ndo comprar o vender</p>
                    </section>

                    <!-- Asset Charts Section -->
                    <section class="asset-analysis-section">
                        <div class="card asset-chart-card">
                            <div class="asset-chart-header">
                                <div class="asset-selector">
                                    <label>Selecciona un activo:</label>
                                    <select id="assetSelector" onchange="loadAssetChart()">
                                        <option value="">-- Elige un activo --</option>
                                    </select>
                                </div>
                                <div class="period-buttons" id="assetPeriodButtons">
                                    <button class="period-btn" data-period="1d">1D</button>
                                    <button class="period-btn" data-period="5d">1S</button>
                                    <button class="period-btn" data-period="1mo">1M</button>
                                    <button class="period-btn active" data-period="3mo">3M</button>
                                    <button class="period-btn" data-period="1y">1A</button>
                                    <button class="period-btn" data-period="max">Max</button>
                                </div>
                            </div>
                            
                            <!-- Asset Info -->
                            <div class="asset-info-panel" id="assetInfoPanel" style="display: none;">
                                <div class="asset-main-info">
                                    <div class="asset-icon-large" id="assetIconLarge">üìä</div>
                                    <div class="asset-details">
                                        <h3 id="assetName">-</h3>
                                        <span class="asset-ticker-badge" id="assetTickerBadge">-</span>
                                    </div>
                                    <div class="asset-price-info">
                                        <div class="current-price" id="assetCurrentPrice">-</div>
                                        <div class="price-change" id="assetPriceChange">-</div>
                                    </div>
                                </div>
                                <div class="asset-stats">
                                    <div class="stat-item">
                                        <span class="stat-label">Tu posici√≥n</span>
                                        <span class="stat-value" id="assetPosition">-</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-label">Valor actual</span>
                                        <span class="stat-value" id="assetValue">-</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-label">Ganancia/P√©rdida</span>
                                        <span class="stat-value" id="assetGainLoss">-</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-label">% de tu cartera</span>
                                        <span class="stat-value" id="assetWeight">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Chart Container -->
                            <div class="asset-chart-container" id="assetChartContainer">
                                <div class="chart-placeholder">
                                    <span class="placeholder-icon">üìä</span>
                                    <p>Selecciona un activo para ver su evoluci√≥n</p>
                                </div>
                                <canvas id="assetHistoryChart" style="display: none;"></canvas>
                            </div>

                            <!-- Quick Actions -->
                            <div class="asset-actions" id="assetActions" style="display: none;">
                                <button class="btn-action btn-buy" onclick="showBuyAdvice()">
                                    üí∞ ¬øDeber√≠a comprar m√°s?
                                </button>
                                <button class="btn-action btn-analyze" onclick="showDetailedAnalysis()">
                                    üîç An√°lisis detallado
                                </button>
                            </div>
                        </div>
                    </section>

                    <!-- Quick Asset Cards -->
                    <section class="asset-quick-cards">
                        <h3>üìä Resumen R√°pido de tus Activos</h3>
                        <div class="asset-cards-grid" id="assetCardsGrid">
                            <!-- Cards will be populated by JavaScript -->
                        </div>
                    </section>

                    <section class="analysis-metrics">
                        <div class="card metric-card">
                            <h4>Rendimiento vs Benchmark</h4>
                            <div class="chart-container-sm">
                                <canvas id="benchmarkChart"></canvas>
                            </div>
                            <div class="metric-footer">
                                <span>Tu cartera vs S&P 500</span>
                            </div>
                        </div>

                        <div class="card metric-card">
                            <h4>Distribuci√≥n de Riesgo</h4>
                            <div class="risk-bars">
                                <div class="risk-item">
                                    <span class="risk-label">Bajo riesgo</span>
                                    <div class="risk-bar"><div class="risk-fill low" style="width: 30%"></div></div>
                                    <span class="risk-pct" id="riskLow">30%</span>
                                </div>
                                <div class="risk-item">
                                    <span class="risk-label">Medio riesgo</span>
                                    <div class="risk-bar"><div class="risk-fill medium" style="width: 45%"></div></div>
                                    <span class="risk-pct" id="riskMedium">45%</span>
                                </div>
                                <div class="risk-item">
                                    <span class="risk-label">Alto riesgo</span>
                                    <div class="risk-bar"><div class="risk-fill high" style="width: 25%"></div></div>
                                    <span class="risk-pct" id="riskHigh">25%</span>
                                </div>
                            </div>
                        </div>

                        <div class="card metric-card">
                            <h4>Correlaci√≥n de Activos</h4>
                            <div class="correlation-matrix" id="correlationMatrix">
                                <p class="text-muted">Matriz de correlaci√≥n basada en rendimientos hist√≥ricos</p>
                            </div>
                        </div>
                    </section>

                    <section class="analysis-details">
                        <div class="card">
                            <h4>Top Movers (30 d√≠as)</h4>
                            <div class="movers-list" id="topMovers">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <div class="card">
                            <h4>Estad√≠sticas de Rendimiento</h4>
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <span class="stat-name">Mejor d√≠a</span>
                                    <span class="stat-value positive" id="bestDay">+0.00%</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-name">Peor d√≠a</span>
                                    <span class="stat-value negative" id="worstDay">-0.00%</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-name">D√≠as positivos</span>
                                    <span class="stat-value" id="positiveDays">0%</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-name">Rendimiento YTD</span>
                                    <span class="stat-value" id="ytdReturn">0.00%</span>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- Transactions Page -->
                <div class="page page-transactions" id="page-transactions">
                    <section class="transactions-header">
                        <h2>Registro de Transacciones</h2>
                        <button class="btn-primary" id="btnAddTransaction">+ Nueva Transacci√≥n</button>
                    </section>

                    <div class="card">
                        <div class="transactions-filters">
                            <input type="date" id="txDateFrom" class="input-date">
                            <span>hasta</span>
                            <input type="date" id="txDateTo" class="input-date">
                            <select id="txType" class="select-filter">
                                <option value="all">Todas</option>
                                <option value="buy">Compras</option>
                                <option value="sell">Ventas</option>
                                <option value="dividend">Dividendos</option>
                            </select>
                        </div>

                        <table class="transactions-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo</th>
                                    <th>Activo</th>
                                    <th class="text-right">Cantidad</th>
                                    <th class="text-right">Precio</th>
                                    <th class="text-right">Total</th>
                                    <th>Broker</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsBody">
                                <tr>
                                    <td colspan="8" class="text-muted text-center">
                                        No hay transacciones registradas. Haz clic en "Nueva Transacci√≥n" para a√±adir una.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Transaction Modal -->
                    <div class="modal" id="transactionModal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>Nueva Transacci√≥n</h3>
                                <button class="modal-close" id="closeTransactionModal">√ó</button>
                            </div>
                            <form id="transactionForm">
                                <div class="form-group">
                                    <label>Tipo de transacci√≥n</label>
                                    <select name="type" required>
                                        <option value="buy">Compra</option>
                                        <option value="sell">Venta</option>
                                        <option value="dividend">Dividendo</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Activo (ticker)</label>
                                    <input type="text" name="ticker" placeholder="AAPL, BTC, VWCE.DE..." required>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Cantidad</label>
                                        <input type="number" name="quantity" step="any" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Precio unitario</label>
                                        <input type="number" name="price" step="any" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Fecha</label>
                                        <input type="date" name="date" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Broker</label>
                                        <select name="broker">
                                            <option value="TradeRepublic">Trade Republic</option>
                                            <option value="MyInvestor">MyInvestor</option>
                                            <option value="Kraken">Kraken</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Notas (opcional)</label>
                                    <textarea name="notes" rows="2"></textarea>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn-secondary" id="cancelTransaction">Cancelar</button>
                                    <button type="submit" class="btn-primary">Guardar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Goals Page -->
                <div class="page page-goals" id="page-goals">
                    <section class="goals-header">
                        <h2>Objetivos Financieros</h2>
                        <button class="btn-primary" id="btnAddGoal">+ Nuevo Objetivo</button>
                    </section>

                    <div class="goals-grid" id="goalsContainer">
                        <!-- Example goals -->
                        <div class="goal-card">
                            <div class="goal-icon">üè†</div>
                            <h4>Entrada casa</h4>
                            <div class="goal-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 35%"></div>
                                </div>
                                <div class="progress-info">
                                    <span>17.500 ‚Ç¨ / 50.000 ‚Ç¨</span>
                                    <span>35%</span>
                                </div>
                            </div>
                            <div class="goal-details">
                                <span>üìÖ Meta: Dic 2027</span>
                                <span>üí∞ 400 ‚Ç¨/mes necesarios</span>
                            </div>
                        </div>

                        <div class="goal-card">
                            <div class="goal-icon">üöó</div>
                            <h4>Coche nuevo</h4>
                            <div class="goal-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 60%"></div>
                                </div>
                                <div class="progress-info">
                                    <span>12.000 ‚Ç¨ / 20.000 ‚Ç¨</span>
                                    <span>60%</span>
                                </div>
                            </div>
                            <div class="goal-details">
                                <span>üìÖ Meta: Jun 2026</span>
                                <span>üí∞ 500 ‚Ç¨/mes necesarios</span>
                            </div>
                        </div>

                        <div class="goal-card goal-add">
                            <span class="add-icon">+</span>
                            <span>A√±adir objetivo</span>
                        </div>
                    </div>

                    <section class="goals-projection">
                        <div class="card">
                            <h4>Proyecci√≥n de Patrimonio</h4>
                            <div class="chart-container">
                                <canvas id="projectionChart"></canvas>
                            </div>
                            <div class="projection-controls">
                                <div class="form-group inline">
                                    <label>Aportaci√≥n mensual:</label>
                                    <input type="number" id="monthlyContribution" value="500" step="50">
                                    <span>‚Ç¨</span>
                                </div>
                                <div class="form-group inline">
                                    <label>Rentabilidad esperada:</label>
                                    <input type="number" id="expectedReturn" value="7" step="0.5">
                                    <span>%</span>
                                </div>
                                <button class="btn-secondary" id="updateProjection">Actualizar</button>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- Portfolio Manager Page -->
                <div class="page page-portfolio-manager" id="page-portfolio-manager">
                    <section class="manager-header">
                        <div>
                            <h2>üíº Gestionar Mi Cartera</h2>
                            <p>A√±ade, edita o importa tus posiciones de inversi√≥n</p>
                        </div>
                    </section>

                    <!-- Action Cards -->
                    <div class="manager-actions">
                        <button type="button" class="action-card" onclick="showAddPositionModal()">
                            <span class="action-icon">‚ûï</span>
                            <h4>A√±adir Posici√≥n</h4>
                            <p>A√±ade una nueva posici√≥n manualmente</p>
                        </button>
                        <button type="button" class="action-card" onclick="showImportModal()">
                            <span class="action-icon">üì§</span>
                            <h4>Importar CSV</h4>
                            <p>Importa desde Trade Republic, MyInvestor, Kraken...</p>
                        </button>
                        <button type="button" class="action-card" onclick="showQuickAddModal()">
                            <span class="action-icon">‚ö°</span>
                            <h4>A√±adir R√°pido</h4>
                            <p>A√±ade m√∫ltiples posiciones a la vez</p>
                        </button>
                    </div>

                    <!-- Current Positions -->
                    <div class="card manager-positions">
                        <div class="card-header">
                            <h3>üìä Mis Posiciones Actuales</h3>
                            <div class="positions-actions">
                                <button class="btn-secondary" onclick="exportPositions()">üì• Exportar CSV</button>
                                <button class="btn-secondary btn-danger" onclick="confirmClearAll()">üóëÔ∏è Limpiar Todo</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="manager-table">
                                <thead>
                                    <tr>
                                        <th>Ticker</th>
                                        <th>Tipo</th>
                                        <th>Broker</th>
                                        <th class="text-right">Cantidad</th>
                                        <th class="text-right">Coste/Unidad</th>
                                        <th class="text-right">Divisa</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="managerPositionsBody">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">Cargando posiciones...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Import History -->
                    <div class="card">
                        <h3>üìú Historial de Importaciones</h3>
                        <div id="importHistory" class="import-history">
                            <p class="text-muted">No hay importaciones recientes</p>
                        </div>
                    </div>
                </div>

                <!-- Add Position Modal -->
                <div class="modal" id="addPositionModal">
                    <div class="modal-content modal-lg">
                        <div class="modal-header">
                            <h3>‚ûï A√±adir Nueva Posici√≥n</h3>
                            <button class="modal-close" onclick="closeModal('addPositionModal')">√ó</button>
                        </div>
                        <form id="addPositionForm" onsubmit="handleAddPosition(event)">
                            <!-- Tipo de activo primero -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Tipo de Activo *</label>
                                    <select name="type" id="addType" required onchange="toggleISINField()">
                                        <option value="crypto">ü™ô Criptomoneda</option>
                                        <option value="etf">üìä ETF / Fondo</option>
                                        <option value="stock">üìà Acci√≥n</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Broker *</label>
                                    <select name="broker" required>
                                        <option value="Kraken">Kraken</option>
                                        <option value="TradeRepublic">Trade Republic</option>
                                        <option value="MyInvestor">MyInvestor</option>
                                        <option value="DEGIRO">DEGIRO</option>
                                        <option value="Interactive Brokers">Interactive Brokers</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Ticker o ISIN -->
                            <div class="form-row">
                                <div class="form-group" id="tickerGroup">
                                    <label>Ticker / S√≠mbolo *</label>
                                    <input type="text" name="ticker" id="addTicker" placeholder="BTC, ETH, AAPL..." required>
                                    <small class="form-help">El s√≠mbolo que ves en la plataforma (BTC, ETH, SOL...)</small>
                                </div>
                                <div class="form-group" id="isinGroup" style="display:none;">
                                    <label>ISIN (opcional)</label>
                                    <input type="text" name="isin" id="addISIN" placeholder="IE00B4ND3602">
                                    <small class="form-help">Lo encuentras en los detalles del ETF/fondo</small>
                                </div>
                            </div>

                            <!-- NUEVA FORMA: Importe invertido -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label>üí∞ Importe Invertido (‚Ç¨) *</label>
                                    <input type="number" name="amount_invested" id="addAmount" step="any" min="0" placeholder="50" required oninput="calculateQuantity()">
                                    <small class="form-help">¬øCu√°ntos euros metiste?</small>
                                </div>
                                <div class="form-group">
                                    <label>üìâ Precio por Unidad (‚Ç¨) *</label>
                                    <input type="number" name="unit_price" id="addUnitPrice" step="any" min="0" placeholder="74.68" required oninput="calculateQuantity()">
                                    <small class="form-help">¬øA cu√°nto estaba cuando compraste?</small>
                                </div>
                            </div>

                            <!-- Cantidad calculada autom√°ticamente -->
                            <div class="calculated-result" id="calculatedResult" style="display:none;">
                                <div class="result-box">
                                    <span class="result-label">üìä Cantidad calculada:</span>
                                    <span class="result-value" id="calculatedQuantity">0</span>
                                    <span class="result-unit" id="calculatedUnit">unidades</span>
                                </div>
                            </div>

                            <!-- Campo oculto para la cantidad real -->
                            <input type="hidden" name="quantity" id="addQuantity">
                            <input type="hidden" name="avg_price" id="addAvgPrice">
                            <input type="hidden" name="currency" value="EUR">

                            <div class="form-actions">
                                <button type="button" class="btn-secondary" onclick="closeModal('addPositionModal')">Cancelar</button>
                                <button type="submit" class="btn-primary">A√±adir Posici√≥n</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Import CSV Modal -->
                <div class="modal" id="importModal">
                    <div class="modal-content modal-lg">
                        <div class="modal-header">
                            <h3>üì§ Importar desde CSV</h3>
                            <button class="modal-close" onclick="closeModal('importModal')">√ó</button>
                        </div>
                        <div class="import-steps">
                            <!-- Step 1: Upload -->
                            <div class="import-step active" id="importStep1">
                                <h4>Paso 1: Selecciona el archivo</h4>
                                <div class="upload-zone" id="uploadZone">
                                    <span class="upload-icon">üìÅ</span>
                                    <p>Arrastra un archivo CSV aqu√≠ o haz clic para seleccionar</p>
                                    <input type="file" id="csvFileInput" accept=".csv,.txt" hidden>
                                    <small>Formatos soportados: Trade Republic, MyInvestor, Kraken, CSV gen√©rico</small>
                                </div>
                                <div class="form-group" style="margin-top: 1rem;">
                                    <label>Broker de origen</label>
                                    <select id="importBroker">
                                        <option value="TradeRepublic">Trade Republic</option>
                                        <option value="MyInvestor">MyInvestor</option>
                                        <option value="Kraken">Kraken</option>
                                        <option value="DEGIRO">DEGIRO</option>
                                        <option value="Manual">Otro / Manual</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Step 2: Preview -->
                            <div class="import-step" id="importStep2">
                                <h4>Paso 2: Revisa los datos</h4>
                                <div class="preview-info">
                                    <span id="previewFormat">Formato detectado: --</span>
                                    <span id="previewRows">Filas: --</span>
                                </div>
                                <div class="preview-table-container">
                                    <table class="preview-table" id="previewTable">
                                        <thead id="previewHead"></thead>
                                        <tbody id="previewBody"></tbody>
                                    </table>
                                </div>
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="mergeExisting" checked>
                                        Combinar con posiciones existentes (recomendado)
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Step 3: Confirm -->
                            <div class="import-step" id="importStep3">
                                <h4>Paso 3: Importaci√≥n completada</h4>
                                <div class="import-result" id="importResult">
                                    <!-- Filled by JS -->
                                </div>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn-secondary" onclick="closeModal('importModal')">Cancelar</button>
                            <button type="button" class="btn-secondary" id="importBackBtn" onclick="importBack()" style="display:none;">‚Üê Atr√°s</button>
                            <button type="button" class="btn-primary" id="importNextBtn" onclick="importNext()">Siguiente ‚Üí</button>
                        </div>
                    </div>
                </div>

                <!-- Quick Add Modal -->
                <div class="modal" id="quickAddModal">
                    <div class="modal-content modal-lg">
                        <div class="modal-header">
                            <h3>‚ö° A√±adir M√∫ltiples Posiciones</h3>
                            <button class="modal-close" onclick="closeModal('quickAddModal')">√ó</button>
                        </div>
                        <div class="quick-add-instructions">
                            <p>Pega tus posiciones en formato: <code>TICKER, CANTIDAD, PRECIO, TIPO, BROKER</code></p>
                            <small>Ejemplo: AAPL, 10, 150, stock, TradeRepublic</small>
                        </div>
                        <div class="form-group">
                            <textarea id="quickAddText" rows="10" placeholder="AAPL, 10, 150, stock, TradeRepublic
MSFT, 5, 280, stock, MyInvestor
BTC, 0.5, 40000, crypto, Kraken
VWCE.DE, 20, 100, etf, MyInvestor"></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn-secondary" onclick="closeModal('quickAddModal')">Cancelar</button>
                            <button type="button" class="btn-primary" onclick="handleQuickAdd()">Importar Todo</button>
                        </div>
                    </div>
                </div>

                <!-- Edit Position Modal -->
                <div class="modal" id="editPositionModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>‚úèÔ∏è Editar Posici√≥n</h3>
                            <button class="modal-close" onclick="closeModal('editPositionModal')">√ó</button>
                        </div>
                        <form id="editPositionForm" onsubmit="handleEditPosition(event)">
                            <input type="hidden" name="original_ticker" id="editOriginalTicker">
                            <div class="form-group">
                                <label>Ticker</label>
                                <input type="text" name="ticker" id="editTicker" readonly class="readonly">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Cantidad</label>
                                    <input type="number" name="quantity" id="editQuantity" step="any" required>
                                </div>
                                <div class="form-group">
                                    <label>Coste/Unidad</label>
                                    <input type="number" name="avg_price" id="editAvgPrice" step="any" required>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn-secondary" onclick="closeModal('editPositionModal')">Cancelar</button>
                                <button type="submit" class="btn-primary">Guardar Cambios</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Alerts Page -->
                <div class="page page-alerts" id="page-alerts">
                    <section class="alerts-header">
                        <h2>Alertas de Precio</h2>
                        <button class="btn-primary" id="btnAddAlert">+ Nueva Alerta</button>
                    </section>

                    <div class="alerts-list" id="alertsList">
                        <div class="alert-item">
                            <div class="alert-info">
                                <span class="alert-ticker">AAPL</span>
                                <span class="alert-condition">Precio &gt; $200</span>
                            </div>
                            <div class="alert-status active">Activa</div>
                            <button class="btn-icon btn-delete">üóëÔ∏è</button>
                        </div>
                        <div class="alert-item">
                            <div class="alert-info">
                                <span class="alert-ticker">BTC</span>
                                <span class="alert-condition">Precio &lt; $40,000</span>
                            </div>
                            <div class="alert-status active">Activa</div>
                            <button class="btn-icon btn-delete">üóëÔ∏è</button>
                        </div>
                        <div class="alert-item triggered">
                            <div class="alert-info">
                                <span class="alert-ticker">NVDA</span>
                                <span class="alert-condition">Cambio diario &gt; 5%</span>
                            </div>
                            <div class="alert-status triggered">¬°Disparada!</div>
                            <button class="btn-icon btn-delete">üóëÔ∏è</button>
                        </div>
                    </div>

                    <!-- Alert Modal -->
                    <div class="modal" id="alertModal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>Nueva Alerta</h3>
                                <button class="modal-close" id="closeAlertModal">√ó</button>
                            </div>
                            <form id="alertForm">
                                <div class="form-group">
                                    <label>Activo</label>
                                    <input type="text" name="ticker" placeholder="AAPL, BTC, etc." required>
                                </div>
                                <div class="form-group">
                                    <label>Condici√≥n</label>
                                    <select name="condition">
                                        <option value="price_above">Precio mayor que</option>
                                        <option value="price_below">Precio menor que</option>
                                        <option value="change_above">Cambio diario mayor que %</option>
                                        <option value="change_below">Cambio diario menor que %</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Valor</label>
                                    <input type="number" name="value" step="any" required>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn-secondary" id="cancelAlert">Cancelar</button>
                                    <button type="submit" class="btn-primary">Crear Alerta</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Calculators Page -->
                <div class="page page-calculators" id="page-calculators">
                    <section class="calculators-header">
                        <h2>Calculadoras Financieras</h2>
                        <p>Herramientas para planificar tu futuro financiero</p>
                    </section>

                    <div class="calculators-grid">
                        <!-- Compound Interest Calculator -->
                        <div class="card calculator-card">
                            <h4>üîÑ Inter√©s Compuesto</h4>
                            <p class="calc-description">Calcula el crecimiento de tu inversi√≥n con el poder del inter√©s compuesto</p>
                            <form id="compoundForm" class="calc-form">
                                <div class="form-group">
                                    <label>Capital inicial (‚Ç¨)</label>
                                    <input type="number" id="ci_initial" value="10000" step="100">
                                </div>
                                <div class="form-group">
                                    <label>Aportaci√≥n mensual (‚Ç¨)</label>
                                    <input type="number" id="ci_monthly" value="500" step="50">
                                </div>
                                <div class="form-group">
                                    <label>Tasa anual (%)</label>
                                    <input type="number" id="ci_rate" value="7" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label>A√±os</label>
                                    <input type="number" id="ci_years" value="20" step="1">
                                </div>
                                <button type="button" class="btn-primary" onclick="calculateCompound()">Calcular</button>
                            </form>
                            <div class="calc-result" id="compoundResult">
                                <div class="result-main">
                                    <span class="result-label">Valor final</span>
                                    <span class="result-value">--</span>
                                </div>
                                <div class="result-details">
                                    <div><span>Aportado:</span><span id="ci_contributed">--</span></div>
                                    <div><span>Intereses:</span><span id="ci_interest">--</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- FIRE Calculator -->
                        <div class="card calculator-card">
                            <h4>üî• Calculadora FIRE</h4>
                            <p class="calc-description">¬øCu√°nto necesitas para alcanzar la independencia financiera?</p>
                            <form id="fireForm" class="calc-form">
                                <div class="form-group">
                                    <label>Gastos anuales (‚Ç¨)</label>
                                    <input type="number" id="fire_expenses" value="24000" step="1000">
                                </div>
                                <div class="form-group">
                                    <label>Tasa de retiro segura (%)</label>
                                    <input type="number" id="fire_swr" value="4" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label>Tu patrimonio actual (‚Ç¨)</label>
                                    <input type="number" id="fire_current" value="50000" step="1000">
                                </div>
                                <div class="form-group">
                                    <label>Ahorro mensual (‚Ç¨)</label>
                                    <input type="number" id="fire_savings" value="1000" step="100">
                                </div>
                                <button type="button" class="btn-primary" onclick="calculateFIRE()">Calcular</button>
                            </form>
                            <div class="calc-result" id="fireResult">
                                <div class="result-main">
                                    <span class="result-label">N√∫mero FIRE necesario</span>
                                    <span class="result-value">--</span>
                                </div>
                                <div class="result-details">
                                    <div><span>A√±os hasta FIRE:</span><span id="fire_years">--</span></div>
                                    <div><span>Progreso actual:</span><span id="fire_progress">--</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- DCA Calculator -->
                        <div class="card calculator-card">
                            <h4>üìä Simulador DCA</h4>
                            <p class="calc-description">Dollar Cost Averaging: inversi√≥n peri√≥dica autom√°tica</p>
                            <form id="dcaForm" class="calc-form">
                                <div class="form-group">
                                    <label>Inversi√≥n mensual (‚Ç¨)</label>
                                    <input type="number" id="dca_amount" value="200" step="50">
                                </div>
                                <div class="form-group">
                                    <label>Periodo (meses)</label>
                                    <input type="number" id="dca_months" value="24" step="1">
                                </div>
                                <div class="form-group">
                                    <label>Rentabilidad anual esperada (%)</label>
                                    <input type="number" id="dca_return" value="8" step="0.5">
                                </div>
                                <button type="button" class="btn-primary" onclick="calculateDCA()">Calcular</button>
                            </form>
                            <div class="calc-result" id="dcaResult">
                                <div class="result-main">
                                    <span class="result-label">Valor estimado</span>
                                    <span class="result-value">--</span>
                                </div>
                                <div class="result-details">
                                    <div><span>Total invertido:</span><span id="dca_invested">--</span></div>
                                    <div><span>Ganancia estimada:</span><span id="dca_gain">--</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- Dividend Calculator -->
                        <div class="card calculator-card">
                            <h4>üíµ Calculadora de Dividendos</h4>
                            <p class="calc-description">Estima tus ingresos pasivos por dividendos</p>
                            <form id="divForm" class="calc-form">
                                <div class="form-group">
                                    <label>Capital invertido (‚Ç¨)</label>
                                    <input type="number" id="div_capital" value="100000" step="1000">
                                </div>
                                <div class="form-group">
                                    <label>Yield promedio (%)</label>
                                    <input type="number" id="div_yield" value="4" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label>Crecimiento anual dividendo (%)</label>
                                    <input type="number" id="div_growth" value="5" step="0.5">
                                </div>
                                <div class="form-group">
                                    <label>A√±os</label>
                                    <input type="number" id="div_years" value="10" step="1">
                                </div>
                                <button type="button" class="btn-primary" onclick="calculateDividends()">Calcular</button>
                            </form>
                            <div class="calc-result" id="divResult">
                                <div class="result-main">
                                    <span class="result-label">Dividendos anuales (a√±o final)</span>
                                    <span class="result-value">--</span>
                                </div>
                                <div class="result-details">
                                    <div><span>Mensual:</span><span id="div_monthly">--</span></div>
                                    <div><span>Total acumulado:</span><span id="div_total">--</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Advisor Page -->
                <div class="page page-ai-advisor" id="page-ai-advisor">
                    <section class="ai-header">
                        <div class="ai-intro">
                            <span class="ai-avatar">ü§ñ</span>
                            <div>
                                <h2>FinBot - Tu Asesor Financiero IA</h2>
                                <p>Preg√∫ntame sobre inversiones, tu cartera, estrategias, o cualquier duda financiera</p>
                            </div>
                        </div>
                    </section>

                    <div class="chat-container">
                        <div class="chat-messages" id="chatMessages">
                            <div class="chat-message bot">
                                <div class="message-avatar">ü§ñ</div>
                                <div class="message-content">
                                    <p>¬°Hola! Soy <strong>FinBot</strong>, tu asesor financiero virtual. üëã</p>
                                    <p>Puedo ayudarte con:</p>
                                    <ul>
                                        <li>üìä Analizar tu cartera actual</li>
                                        <li>üìö Explicar conceptos de inversi√≥n</li>
                                        <li>üí° Sugerir estrategias generales</li>
                                        <li>‚ö†Ô∏è Identificar riesgos en tu portafolio</li>
                                    </ul>
                                    <p><em>Recuerda: Soy una herramienta educativa, no un asesor financiero regulado.</em></p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chat-suggestions">
                            <button class="suggestion-btn" onclick="askSuggestion('¬øC√≥mo est√° diversificada mi cartera?')">üìä Analizar mi cartera</button>
                            <button class="suggestion-btn" onclick="askSuggestion('¬øQu√© es el inter√©s compuesto y c√≥mo me beneficia?')">üí∞ Inter√©s compuesto</button>
                            <button class="suggestion-btn" onclick="askSuggestion('¬øQu√© estrategia de inversi√≥n me recomiendas para empezar?')">üéØ Estrategias para empezar</button>
                            <button class="suggestion-btn" onclick="askSuggestion('¬øCu√°les son los principales riesgos de mi cartera actual?')">‚ö†Ô∏è Riesgos de mi cartera</button>
                        </div>

                        <form class="chat-input-form" id="chatForm" onsubmit="sendMessage(event)">
                            <div class="chat-input-wrapper">
                                <input type="text" id="chatInput" placeholder="Escribe tu pregunta..." autocomplete="off">
                                <label class="include-portfolio-toggle">
                                    <input type="checkbox" id="includePortfolio" checked>
                                    <span>Incluir datos de mi cartera</span>
                                </label>
                            </div>
                            <button type="submit" class="btn-send" id="btnSend">
                                <span>Enviar</span>
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                                </svg>
                            </button>
                        </form>
                    </div>

                    <div class="ai-disclaimer">
                        <p>‚ö†Ô∏è <strong>Disclaimer:</strong> FinBot proporciona informaci√≥n educativa general. No constituye asesoramiento financiero personalizado. Consulta siempre con un profesional antes de tomar decisiones de inversi√≥n.</p>
                    </div>
                </div>

                <!-- News Page -->
                <div class="page page-news" id="page-news">
                    <section class="news-header">
                        <h2>üì∞ Noticias Financieras</h2>
                        <p>√öltimas noticias que pueden afectar a tus inversiones</p>
                        <div class="news-filters">
                            <button class="chart-btn active" data-filter="all">Todas</button>
                            <button class="chart-btn" data-filter="stocks">Acciones</button>
                            <button class="chart-btn" data-filter="crypto">Crypto</button>
                            <button class="chart-btn" data-filter="economy">Econom√≠a</button>
                            <button class="chart-btn" data-filter="politics">Pol√≠tica</button>
                        </div>
                    </section>
                    
                    <div class="news-grid" id="newsGrid">
                        <!-- News loaded dynamically -->
                    </div>
                </div>

                <!-- Learn Page -->
                <div class="page page-learn" id="page-learn">
                    <!-- Content loaded from learn.html -->
                </div>

                <!-- Documentation Page -->
                <div class="page page-docs" id="page-docs">
                    <!-- Content loaded from docs.html -->
                </div>
            </main>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <span>Actualizando datos...</span>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="js/app.js"></script>
    <script src="js/calculators.js"></script>
    <script src="js/news.js"></script>
    <script src="js/portfolio-manager.js"></script>
    <script src="js/ai-advisor.js"></script>
    <script src="js/asset-analysis.js"></script>
    <script src="js/pages.js"></script>
</body>
</html>
